# Required: HACS integration (https://hacs.xyz/)
# Required: lovelace-mushroom (https://github.com/piitaya/lovelace-mushroom)
# Required: card-mod (https://github.com/thomasloven/lovelace-card-mod)
# Required: stack-in-card (https://github.com/custom-cards/stack-in-card)
#
# Replace <EV_BATTERY_LEVEL> with the entity_id of the ev battery level sensor or emulated entity_id from this script.

type: custom:stack-in-card
mode: vertical
cards:
  - type: custom:mushroom-entity-card
    entity: sensor.ev_current_charging_rule
    primary_info: state
    secondary_info: none
    icon_type: none
    card_mod:
      style:
        mushroom-state-info$: |
          .container {
           --card-primary-font-size: 20px;
           align-items: center;
          padding-bottom: 10px !important;
          padding-top: 10px !important;
          }
          .primary {
            text-align: center !important;
            white-space: pre-wrap !important;
          }
  - type: conditional
    conditions:
      - condition: numeric_state
        entity: <EV_BATTERY_LEVEL>
        below: input_number.ev_min_daily_battery_level
      - condition: state
        entity: <EV_BATTERY_LEVEL>
        state_not: "0.0"
    card:
      type: vertical-stack
      cards:
        - type: markdown
          content: >-
            # ðŸ“Ž {{ states.input_boolean.ev_forced_charging_daily_battery_level.name }}

            **Tvangsladning kan aktiveres manuelt, hvis batteriniveauet falder under det daglige minimumsniveau.**

            <details>
            <summary><b>LÃ¦s mere</b></summary>

              - **Opladning**: Lader op til det daglige minimumsniveau {{ states.input_number.ev_min_daily_battery_level.state | int}}%
              - **Omkostningskontrol**: Opladningen sker ikke i de 4 dyreste timer for at minimere omkostningerne.
                {% for date, price in states.input_boolean.ev_forced_charging_daily_battery_level.attributes.expensive_hours.items() -%}
                 - **{{ date }}** &emsp;&emsp;&emsp; {{price}}
                {% endfor %}
            </details>
        - type: custom:mushroom-entity-card
          entity: input_boolean.ev_forced_charging_daily_battery_level
  - type: conditional
    conditions:
      - condition: state
        entity: binary_sensor.ev_public_charging_session_done
        state: "on"
    card:
      type: vertical-stack
      cards:
        - type: markdown
          content: >-
            ## ðŸ“Ž {{ states.binary_sensor.ev_public_charging_session_done.name
            }}

            {% if state_attr('binary_sensor.ev_public_charging_session_done',
            'public_charging_session') | length > 1 -%} <ha-alert
            alert-type="info"> Mangler at indtast omkostninger for **{{
            state_attr('binary_sensor.ev_public_charging_session_done',
            'public_charging_session') | length }}** offentlig opladninger
            </ha-alert> {%- endif %}

              |  |  |
              |-----------:|:-----------|
              | ðŸ•“ **Tidspunkt:** | {{ state_attr('binary_sensor.ev_public_charging_session_done', 'public_charging_session')[0]['timestamp'] }} |
              | â›½ **Opladning:** | {{ state_attr('binary_sensor.ev_public_charging_session_done', 'public_charging_session')[0]['start_battery_level'] | int }}% âžª {{ state_attr('binary_sensor.ev_public_charging_session_done', 'public_charging_session')[0]['end_battery_level'] | int }}% |
              | ðŸ”‹ **TilfÃ¸jet:** | {{ state_attr('binary_sensor.ev_public_charging_session_done', 'public_charging_session')[0]['added_percentage'] | int }}% |


            **Indtast venligst belÃ¸bet i feltet nedenfor.**


            *TilfÃ¸jes automatisk til historik ~1 min efter indtastning.*

            <center><font color=grey>

            Indtast -1 for at ignorer denne opladning </font></center>
        - type: custom:mushroom-entity-card
          entity: input_number.ev_public_charging_session_cost
          fill_container: false
          icon: mdi:cash-edit
  - type: markdown
    content: "{{ states.sensor.ev_charging_history.attributes.history }}"
view_layout:
  position: sidebar
